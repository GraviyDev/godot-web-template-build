name: Build Godot Web Templates (choose profile)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Which .gdbuild to use (path inside repo)"
        required: true
        default: "build/profiles/web2d_1.gdbuild"
      godot_ref:
        description: "Godot branch/tag (e.g. 4.6-stable)"
        required: true
        default: "4.6-stable"
      threads:
        description: "Build with threads? (yes/no)"
        required: true
        default: "yes"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Checkout Godot source
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot
          ref: ${{ inputs.godot_ref }}
          path: godot

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip scons cmake ninja-build pkg-config

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 4.0.6

      - name: Verify toolchain
        run: |
          emcc -v
          python3 --version
          scons --version

      - name: Build web template_release
        working-directory: godot
        run: |
          EXTRA=""
          if [ "${{ inputs.threads }}" = "no" ]; then EXTRA="threads=no"; fi

          scons -j2 platform=web target=template_release \
            optimize=size_extra lto=full \
            $EXTRA \
            build_profile="${GITHUB_WORKSPACE}/${{ inputs.profile }}"

          ls -la bin
          # Названия zip могут чуть различаться; проще загрузить все zip из bin.
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godot-web-templates-${{ inputs.profile }}
          path: godot/bin/*.zip
