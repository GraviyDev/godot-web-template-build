name: Build Godot Templates (Web + macOS, multiple .gdbuild)

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Target platform: web or macos"
        required: true
        type: choice
        options: [web, macos]
        default: web

      profile:
        description: "Path to .gdbuild inside this repo (e.g. build/profiles/web_min.gdbuild)"
        required: true
        default: "build/profiles/web2d_1.gdbuild"

      godot_ref:
        description: "Godot branch/tag/commit (e.g. 4.6-stable)"
        required: true
        default: "4.6-stable"

      # WEB
      threads:
        description: "Web only: build with threads? (yes/no)"
        required: true
        type: choice
        options: [yes, no]
        default: yes

      emscripten_version:
        description: "Web only: Emscripten version (4.x recommended)"
        required: true
        default: "4.0.6"

      # macOS
      macos_target:
        description: "macOS only: which template to build"
        required: true
        type: choice
        options: [arm64, universal]
        default: universal

jobs:
  build-web:
    if: ${{ inputs.platform == 'web' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository (profiles)
        uses: actions/checkout@v4

      - name: Check profile exists
        run: |
          test -f "${{ inputs.profile }}" || (echo "Profile not found: ${{ inputs.profile }}" && exit 1)
          echo "Using profile: ${{ inputs.profile }}"

      - name: Compute profile slug (safe artifact name)
        shell: bash
        run: |
          PROFILE_FILE="${{ inputs.profile }}"
          PROFILE_BASE="$(basename "$PROFILE_FILE" .gdbuild)"
          PROFILE_SLUG="$(echo "$PROFILE_BASE" | tr -cs 'A-Za-z0-9._-' '_' )"
          echo "PROFILE_SLUG=$PROFILE_SLUG" >> "$GITHUB_ENV"
          echo "PROFILE_SLUG=$PROFILE_SLUG"

      - name: Checkout Godot source
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot
          ref: ${{ inputs.godot_ref }}
          path: godot

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip scons cmake ninja-build pkg-config

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: ${{ inputs.emscripten_version }}

      - name: Verify toolchain
        run: |
          emcc -v
          python3 --version
          scons --version

      # Fix for known gdbuild issue: disabling Mutex/Time/Window breaks compilation
      - name: Patch gdbuild (remove Mutex/Time/Window if disabled)
        run: |
          python3 - << 'PY'
          import json, pathlib
          p = pathlib.Path("${{ inputs.profile }}")
          data = json.loads(p.read_text(encoding="utf-8"))
          bad = {"Mutex", "Time", "Window"}
          changed = False
          if isinstance(data.get("disabled_classes"), list):
            before = list(data["disabled_classes"])
            data["disabled_classes"] = [c for c in before if c not in bad]
            changed = (before != data["disabled_classes"])
          if changed:
            p.write_text(json.dumps(data, ensure_ascii=False, indent=2), encoding="utf-8")
            print("Patched disabled_classes:", bad)
          else:
            print("No patch needed.")
          PY

      - name: Build web template_release
        working-directory: godot
        shell: bash
        run: |
          EXTRA=""
          if [ "${{ inputs.threads }}" = "no" ]; then EXTRA="threads=no"; fi

          scons -j2 platform=web target=template_release \
            optimize=size_extra lto=full \
            $EXTRA \
            build_profile="${GITHUB_WORKSPACE}/${{ inputs.profile }}"

          echo "== bin contents =="
          ls -la bin

      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godot-${{ inputs.godot_ref }}-web-${{ inputs.threads }}-${{ env.PROFILE_SLUG }}
          path: |
            godot/bin/*.zip

  build-macos:
    if: ${{ inputs.platform == 'macos' }}
    runs-on: macos-latest

    steps:
      - name: Checkout this repository (profiles)
        uses: actions/checkout@v4

      - name: Check profile exists
        run: |
          test -f "${{ inputs.profile }}" || (echo "Profile not found: ${{ inputs.profile }}" && exit 1)
          echo "Using profile: ${{ inputs.profile }}"
          echo "macos_target: ${{ inputs.macos_target }}"

      - name: Compute profile slug (safe artifact name)
        shell: bash
        run: |
          PROFILE_FILE="${{ inputs.profile }}"
          PROFILE_BASE="$(basename "$PROFILE_FILE" .gdbuild)"
          PROFILE_SLUG="$(echo "$PROFILE_BASE" | tr -cs 'A-Za-z0-9._-' '_' )"
          echo "PROFILE_SLUG=$PROFILE_SLUG" >> "$GITHUB_ENV"
          echo "PROFILE_SLUG=$PROFILE_SLUG"

      - name: Checkout Godot source
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot
          ref: ${{ inputs.godot_ref }}
          path: godot

      - name: Install SCons
        run: |
          brew update
          brew install scons

      - name: Verify tools
        run: |
          python3 --version
          scons --version
          xcodebuild -version

      - name: Patch gdbuild (remove Mutex/Time/Window if disabled)
        run: |
          python3 - << 'PY'
          import json, pathlib
          p = pathlib.Path("${{ inputs.profile }}")
          data = json.loads(p.read_text(encoding="utf-8"))
          bad = {"Mutex", "Time", "Window"}
          changed = False
          if isinstance(data.get("disabled_classes"), list):
            before = list(data["disabled_classes"])
            data["disabled_classes"] = [c for c in before if c not in bad]
            changed = (before != data["disabled_classes"])
          if changed:
            p.write_text(json.dumps(data, ensure_ascii=False, indent=2), encoding="utf-8")
            print("Patched disabled_classes:", bad)
          else:
            print("No patch needed.")
          PY

      - name: Build macOS templates (arm64 only)
        if: ${{ inputs.macos_target == 'arm64' }}
        working-directory: godot
        shell: bash
        run: |
          scons -j2 platform=macos target=template_debug   arch=arm64 \
            optimize=size_extra lto=full \
            build_profile="${GITHUB_WORKSPACE}/${{ inputs.profile }}"

          scons -j2 platform=macos target=template_release arch=arm64 \
            optimize=size_extra lto=full \
            build_profile="${GITHUB_WORKSPACE}/${{ inputs.profile }}"

          echo "== bin contents =="
          ls -la bin

      - name: Build macOS templates (universal: arm64 + x86_64 + bundle)
        if: ${{ inputs.macos_target == 'universal' }}
        working-directory: godot
        shell: bash
        run: |
          # arm64
          scons -j2 platform=macos target=template_debug   arch=arm64 \
            optimize=size_extra lto=full \
            build_profile="${GITHUB_WORKSPACE}/${{ inputs.profile }}"

          scons -j2 platform=macos target=template_release arch=arm64 \
            optimize=size_extra lto=full \
            build_profile="${GITHUB_WORKSPACE}/${{ inputs.profile }}"

          # x86_64
          scons -j2 platform=macos target=template_debug   arch=x86_64 \
            optimize=size_extra lto=full \
            build_profile="${GITHUB_WORKSPACE}/${{ inputs.profile }}"

          # bundle/universal zip
          scons -j2 platform=macos target=template_release arch=x86_64 generate_bundle=yes \
            optimize=size_extra lto=full \
            build_profile="${GITHUB_WORKSPACE}/${{ inputs.profile }}"

          echo "== bin contents =="
          ls -la bin

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godot-${{ inputs.godot_ref }}-macos-${{ inputs.macos_target }}-${{ env.PROFILE_SLUG }}
          path: |
            godot/bin/*.zip
